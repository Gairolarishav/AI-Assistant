<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastPromos Chat</title>
</head>
<body>
    <div style="text-align: center; margin-top: 50vh; transform: translateY(-50%); color: #177bf3; font-size: x-large;">
        Click the Chat icon in the bottom-right corner to start conversation with the FastPromos assistant
    </div>
<script>
(function(d, t) {
  var v = d.createElement(t), s = d.getElementsByTagName(t)[0];
  v.onload = function () {

    let userID = null;

    window.voiceflow.chat.load({
      verify: { projectID: '6880d2c6031c8915cc49e50a' },
      url: 'https://general-runtime.voiceflow.com',
      versionID: 'production',
      assistant: { persistence: 'memory' },
      voice: { url: 'https://runtime-api.voiceflow.com' }
    });

    let lastSavedTurnCount = 0;
    const chatHistory = [];
    const BATCH_SIZE = 3;

    function extractText(input) {
      if (typeof input === 'string') return input;
      if (Array.isArray(input)) {
        return input.map(block =>
          (block.children || []).map(child => child.text).join('')
        ).join('');
      }
      return '';
    }

    function saveChat() {
      if (chatHistory.length === 0) return;

      fetch('https://fastcashpromo.onrender.com/fastpromos/save-chat/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          user_id: userID,
          transcript: chatHistory
        })
      }).then(() => {
        console.log('✅ Chat saved:', chatHistory.length, 'turns');
      }).catch(error => {
        console.error('❌ Failed to save chat:', error);
      });
    }

    window.addEventListener('message', (event) => {
      if (typeof event.data !== 'string') return;

      try {
        const parsed = JSON.parse(event.data);
        console.log("parsed===", parsed);
        console.log("chatHistory ===", chatHistory);
        
        if (parsed.type === 'voiceflow:save_session' && parsed.payload.status === "ACTIVE") {
          console.log('parsed.payload ==', parsed.payload);
          
          if (parsed.payload?.userID) {
            userID = parsed.payload.userID;
          }
          
          const turns = parsed.payload?.turns || [];
          if (turns.length > lastSavedTurnCount) {
            const newTurns = turns.slice(lastSavedTurnCount);
            for (const turn of newTurns) {
              if (turn.type === 'user') {
                chatHistory.push({
                  source: 'user',
                  text: turn.message,
                  timestamp: turn.timestamp || Date.now()
                });
              } else if (turn.type === 'system') {
                for (const msg of turn.messages || []) {
                  const text = extractText(msg.text);
                  if (text) {
                    chatHistory.push({
                      source: 'assistant',
                      text,
                      timestamp: turn.timestamp || Date.now()
                    });
                  }
                }
              }
            }
            lastSavedTurnCount = turns.length;

            if (chatHistory.length % BATCH_SIZE === 0) {
              saveChat();
            }
          }
        }
        else if (parsed.type === 'voiceflow:close') {
          // ✅ FIXED: Just add a session separator, don't clear history
          if (chatHistory.length > 0) {
            chatHistory.push({
              source: 'system',
              text: '------ New Chat Session Started ------',
              timestamp: Date.now()
            });
          }
          
          // Reset turn count for new session but keep chat history
          lastSavedTurnCount = 0;
          
          console.log('🔄 New session started - continuing chat history');
        }

      } catch (e) {
        console.warn('Failed to parse Voiceflow event:', e);
      }
    });

    // Save chat when page is about to be hidden/closed
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden' && chatHistory.length > 0) {
        navigator.sendBeacon(
          'https://fastcashpromo.onrender.com/fastpromos/save-chat/',
          new Blob([JSON.stringify({
            user_id: userID,
            transcript: chatHistory
          })], { type: 'application/json' })
        );
      }
    });

    // Additional safety: Save on window beforeunload
    window.addEventListener('beforeunload', () => {
      if (chatHistory.length > 0) {
        navigator.sendBeacon(
          'https://fastcashpromo.onrender.com/fastpromos/save-chat/',
          new Blob([JSON.stringify({
            user_id: userID,
            transcript: chatHistory
          })], { type: 'application/json' })
        );
      }
    });

  };
  v.src = "https://cdn.voiceflow.com/widget-next/bundle.mjs";
  v.type = "text/javascript"; 
  s.parentNode.insertBefore(v, s);
})(document, 'script');
</script>
</body>
</html>
